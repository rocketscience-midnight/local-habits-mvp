<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Unit Tests ‚Äì Local Habits</title>
  <style>
    * { margin: 0; box-sizing: border-box; }
    body { font-family: -apple-system, system-ui, sans-serif; padding: 20px; background: #1A1A2E; color: #E8E8E8; }
    h1 { margin-bottom: 16px; }
    .summary { font-size: 18px; margin-bottom: 20px; padding: 12px; border-radius: 8px; }
    .summary.pass { background: #1B4332; color: #8ED88E; }
    .summary.fail { background: #4A1020; color: #E84545; }
    .group { margin-bottom: 24px; }
    .group-title { font-size: 16px; font-weight: 700; color: #8B5CF6; margin-bottom: 8px; }
    .test { padding: 6px 12px; border-radius: 4px; margin-bottom: 4px; font-size: 14px; font-family: monospace; }
    .test.pass { background: #0D2818; color: #8ED88E; }
    .test.fail { background: #2D0A0A; color: #E84545; }
    .test .label { color: #A0A0B0; margin-right: 8px; }
  </style>
</head>
<body>
  <h1>üß™ Unit Tests</h1>
  <div id="summary" class="summary"></div>
  <div id="results"></div>

  <script type="module">
    // ========== Mini Test Framework ==========
    let passed = 0, failed = 0;
    const results = document.getElementById('results');
    const groups = {};

    function group(name) {
      if (!groups[name]) {
        const div = document.createElement('div');
        div.className = 'group';
        div.innerHTML = `<div class="group-title">${name}</div>`;
        results.appendChild(div);
        groups[name] = div;
      }
      return groups[name];
    }

    function test(groupName, name, fn) {
      const g = group(groupName);
      const div = document.createElement('div');
      div.className = 'test';
      try {
        fn();
        div.className = 'test pass';
        div.innerHTML = `<span class="label">‚úÖ</span>${name}`;
        passed++;
      } catch (e) {
        div.className = 'test fail';
        div.innerHTML = `<span class="label">‚ùå</span>${name} ‚Äî ${e.message}`;
        failed++;
      }
      g.appendChild(div);
    }

    function eq(actual, expected, msg = '') {
      const a = JSON.stringify(actual);
      const e = JSON.stringify(expected);
      if (a !== e) throw new Error(`${msg} Expected ${e}, got ${a}`);
    }

    function ok(val, msg = '') {
      if (!val) throw new Error(msg || 'Expected truthy');
    }

    // ========== Import modules ==========
    import {
      todayString, getDayOfWeek, getWeekStart, isWeeklyHabit,
      isHabitDueToday, calculateStreak, calculateBestStreak,
      countByDate, getISOWeekKey, WEEKDAYS_MONDAY
    } from './js/utils/dates.js';

    import { escapeHtml } from './js/utils/sanitize.js';

    import {
      RARITY_LABELS, RARITY_COLORS, RARITY_TO_STAGE
    } from './js/utils/rewards.js';

    // Helper: date string N days ago
    function daysAgoStr(n) {
      const d = new Date(); d.setDate(d.getDate() - n);
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    // ========== dates.js ==========

    test('dates.js', 'todayString() returns YYYY-MM-DD format', () => {
      const s = todayString();
      ok(/^\d{4}-\d{2}-\d{2}$/.test(s), `Format wrong: ${s}`);
    });

    test('dates.js', 'todayString() matches local date', () => {
      const now = new Date();
      const expected = now.getFullYear() + '-' +
        String(now.getMonth() + 1).padStart(2, '0') + '-' +
        String(now.getDate()).padStart(2, '0');
      eq(todayString(), expected);
    });

    // getDayOfWeek returns 1=Mon..7=Sun (ISO standard)
    test('dates.js', 'getDayOfWeek("2026-02-23") = 1 (Monday)', () => {
      eq(getDayOfWeek('2026-02-23'), 1);
    });

    test('dates.js', 'getDayOfWeek("2026-02-22") = 7 (Sunday)', () => {
      eq(getDayOfWeek('2026-02-22'), 7);
    });

    test('dates.js', 'getDayOfWeek("2026-02-27") = 5 (Friday)', () => {
      eq(getDayOfWeek('2026-02-27'), 5);
    });

    test('dates.js', 'getWeekStart("2026-02-25") = "2026-02-23" (Wed‚ÜíMon)', () => {
      eq(getWeekStart('2026-02-25'), '2026-02-23');
    });

    test('dates.js', 'getWeekStart("2026-02-23") = "2026-02-23" (Mon‚ÜíMon)', () => {
      eq(getWeekStart('2026-02-23'), '2026-02-23');
    });

    test('dates.js', 'getWeekStart("2026-03-01") = "2026-02-23" (Sun‚ÜíMon)', () => {
      eq(getWeekStart('2026-03-01'), '2026-02-23');
    });

    test('dates.js', 'isWeeklyHabit: daily ‚Üí false', () => {
      eq(isWeeklyHabit({ frequency: 'daily' }), false);
    });

    test('dates.js', 'isWeeklyHabit: weekly object ‚Üí true', () => {
      eq(isWeeklyHabit({ frequency: { type: 'weekly', timesPerWeek: 3 } }), true);
    });

    test('dates.js', 'isWeeklyHabit: no frequency ‚Üí falsy', () => {
      ok(!isWeeklyHabit({}), 'Should be falsy');
    });

    // countByDate takes an array of date STRINGS (not objects)
    test('dates.js', 'countByDate groups date strings correctly', () => {
      const dates = ['2026-02-22', '2026-02-22', '2026-02-21'];
      const result = countByDate(dates);
      eq(result['2026-02-22'], 2);
      eq(result['2026-02-21'], 1);
    });

    test('dates.js', 'getISOWeekKey("2026-02-23") = "2026-W09"', () => {
      eq(getISOWeekKey('2026-02-23'), '2026-W09');
    });

    test('dates.js', 'getISOWeekKey edge case: "2025-12-29" belongs to 2026-W01', () => {
      eq(getISOWeekKey('2025-12-29'), '2026-W01');
    });

    test('dates.js', 'WEEKDAYS_MONDAY has 7 entries starting with Mo', () => {
      eq(WEEKDAYS_MONDAY.length, 7);
      eq(WEEKDAYS_MONDAY[0], 'Mo');
      eq(WEEKDAYS_MONDAY[6], 'So');
    });

    // ========== dates.js - isHabitDueToday ==========
    // Note: isHabitDueToday only checks IF the habit is scheduled for today,
    // NOT whether the target has been met. Daily habits always return true.

    test('dates.js ‚Äì Due', 'daily habit ‚Üí always due', () => {
      ok(isHabitDueToday({ frequency: 'daily' }), 'Daily should always be due');
    });

    test('dates.js ‚Äì Due', 'weekly habit ‚Üí also due (flexible schedule)', () => {
      ok(isHabitDueToday({ frequency: { type: 'weekly', timesPerWeek: 3 } }), 'Weekly should be due');
    });

    // ========== dates.js - Streaks ==========
    // calculateStreak(completionDates, habit) - dates are strings, not objects

    test('dates.js ‚Äì Streaks', 'calculateStreak: daily habit, 5 consecutive days', () => {
      const habit = { frequency: 'daily', targetPerDay: 1 };
      const dates = [];
      for (let i = 0; i < 5; i++) dates.push(daysAgoStr(i));
      const streak = calculateStreak(dates, habit);
      eq(streak, 5);
    });

    test('dates.js ‚Äì Streaks', 'calculateStreak: no completions ‚Üí 0', () => {
      eq(calculateStreak([], { frequency: 'daily', targetPerDay: 1 }), 0);
    });

    test('dates.js ‚Äì Streaks', 'calculateStreak: gap 2 days ago ‚Üí 1', () => {
      const habit = { frequency: 'daily', targetPerDay: 1 };
      // Today + 3 days ago (skip yesterday and day before)
      const dates = [daysAgoStr(0), daysAgoStr(3)];
      eq(calculateStreak(dates, habit), 1);
    });

    test('dates.js ‚Äì Streaks', 'calculateStreak: multi-target per day', () => {
      const habit = { frequency: 'daily', targetPerDay: 2 };
      const today = daysAgoStr(0);
      const yesterday = daysAgoStr(1);
      // Today 2x, yesterday 2x = streak of 2
      const dates = [today, today, yesterday, yesterday];
      eq(calculateStreak(dates, habit), 2);
    });

    test('dates.js ‚Äì Streaks', 'calculateStreak: multi-target not met ‚Üí streak breaks', () => {
      const habit = { frequency: 'daily', targetPerDay: 2 };
      const today = daysAgoStr(0);
      const yesterday = daysAgoStr(1);
      // Today 2x, yesterday only 1x = streak of 1
      const dates = [today, today, yesterday];
      eq(calculateStreak(dates, habit), 1);
    });

    test('dates.js ‚Äì Streaks', 'calculateBestStreak finds older longer streak', () => {
      const habit = { frequency: 'daily', targetPerDay: 1 };
      const dates = [];
      // Old streak: 10 days (20-11 days ago)
      for (let i = 11; i <= 20; i++) dates.push(daysAgoStr(i));
      // Current streak: 2 days
      dates.push(daysAgoStr(0), daysAgoStr(1));
      const best = calculateBestStreak(dates, habit);
      const current = calculateStreak(dates, habit);
      ok(best >= 10, `Best should be ‚â•10, got ${best}`);
      ok(best > current, `Best (${best}) should be > current (${current})`);
    });

    // ========== sanitize.js ==========

    test('sanitize.js', 'escapes script tags', () => {
      const result = escapeHtml('<scr' + 'ipt>alert("xss")<\/scr' + 'ipt>');
      ok(!result.includes('<scr' + 'ipt>'), 'Should not contain raw script tag');
      ok(result.includes('&lt;'), 'Should contain &lt;');
    });

    test('sanitize.js', 'escapes quotes and ampersands', () => {
      const result = escapeHtml('"quotes\' & ampersands"');
      ok(result.includes('&amp;'), 'Should escape &');
    });

    test('sanitize.js', 'leaves normal text unchanged', () => {
      eq(escapeHtml('Hello World 123'), 'Hello World 123');
    });

    // ========== rewards.js ==========

    test('rewards.js', 'RARITY_TO_STAGE: common=1, epic=4, legendary=5', () => {
      eq(RARITY_TO_STAGE.common, 1);
      eq(RARITY_TO_STAGE.uncommon, 2);
      eq(RARITY_TO_STAGE.rare, 3);
      eq(RARITY_TO_STAGE.epic, 4);
      eq(RARITY_TO_STAGE.legendary, 5);
    });

    test('rewards.js', 'legendary stage differs from epic', () => {
      ok(RARITY_TO_STAGE.legendary !== RARITY_TO_STAGE.epic, 'Legendary should differ from epic');
    });

    test('rewards.js', 'RARITY_LABELS has all 5 rarities in German', () => {
      eq(Object.keys(RARITY_LABELS).length, 5);
      eq(RARITY_LABELS.common, 'Gew√∂hnlich');
      eq(RARITY_LABELS.legendary, 'Legend√§r');
    });

    test('rewards.js', 'RARITY_COLORS has all 5 entries', () => {
      eq(Object.keys(RARITY_COLORS).length, 5);
      ok(RARITY_COLORS.legendary.startsWith('#'), 'Should be hex color');
    });

    // ========== Summary ==========
    const summary = document.getElementById('summary');
    const total = passed + failed;
    summary.className = `summary ${failed === 0 ? 'pass' : 'fail'}`;
    summary.textContent = failed === 0
      ? `‚úÖ Alle ${total} Tests bestanden!`
      : `‚ùå ${failed} von ${total} Tests fehlgeschlagen`;

  </script>
</body>
</html>
