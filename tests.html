<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Unit Tests ‚Äì Local Habits</title>
  <style>
    * { margin: 0; box-sizing: border-box; }
    body { font-family: -apple-system, system-ui, sans-serif; padding: 20px; background: #1A1A2E; color: #E8E8E8; }
    h1 { margin-bottom: 16px; }
    .summary { font-size: 18px; margin-bottom: 20px; padding: 12px; border-radius: 8px; }
    .summary.pass { background: #1B4332; color: #8ED88E; }
    .summary.fail { background: #4A1020; color: #E84545; }
    .group { margin-bottom: 24px; }
    .group-title { font-size: 16px; font-weight: 700; color: #8B5CF6; margin-bottom: 8px; }
    .test { padding: 6px 12px; border-radius: 4px; margin-bottom: 4px; font-size: 14px; font-family: monospace; }
    .test.pass { background: #0D2818; color: #8ED88E; }
    .test.fail { background: #2D0A0A; color: #E84545; }
    .test .label { color: #A0A0B0; margin-right: 8px; }
  </style>
</head>
<body>
  <h1>üß™ Unit Tests</h1>
  <div id="summary" class="summary"></div>
  <div id="results"></div>

  <script type="module">
    // ========== Mini Test Framework ==========
    let passed = 0, failed = 0;
    const results = document.getElementById('results');
    const groups = {};

    function group(name) {
      if (!groups[name]) {
        const div = document.createElement('div');
        div.className = 'group';
        div.innerHTML = `<div class="group-title">${name}</div>`;
        results.appendChild(div);
        groups[name] = div;
      }
      return groups[name];
    }

    function test(groupName, name, fn) {
      const g = group(groupName);
      const div = document.createElement('div');
      div.className = 'test';
      try {
        fn();
        div.className = 'test pass';
        div.innerHTML = `<span class="label">‚úÖ</span>${name}`;
        passed++;
      } catch (e) {
        div.className = 'test fail';
        div.innerHTML = `<span class="label">‚ùå</span>${name} ‚Äî ${e.message}`;
        failed++;
      }
      g.appendChild(div);
    }

    function eq(actual, expected, msg = '') {
      const a = JSON.stringify(actual);
      const e = JSON.stringify(expected);
      if (a !== e) throw new Error(`${msg} Expected ${e}, got ${a}`);
    }

    function ok(val, msg = '') {
      if (!val) throw new Error(msg || 'Expected truthy');
    }

    // ========== Import modules ==========
    import {
      todayString, getDayOfWeek, getWeekStart, isWeeklyHabit,
      isHabitDueToday, calculateStreak, calculateBestStreak,
      countByDate, getISOWeekKey, WEEKDAYS_MONDAY
    } from './js/utils/dates.js';

    import { escapeHtml } from './js/utils/sanitize.js';

    import {
      RARITY_LABELS, RARITY_COLORS, RARITY_TO_STAGE
    } from './js/utils/rewards.js';

    // Helper: date string N days ago
    function daysAgoStr(n) {
      const d = new Date(); d.setDate(d.getDate() - n);
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    // ========== dates.js ==========

    test('dates.js', 'When todayString() is called ‚Üí expect YYYY-MM-DD format', () => {
      const s = todayString();
      ok(/^\d{4}-\d{2}-\d{2}$/.test(s), `Format wrong: ${s}`);
    });

    test('dates.js', 'When todayString() is called ‚Üí expect local date (not UTC)', () => {
      const now = new Date();
      const expected = now.getFullYear() + '-' +
        String(now.getMonth() + 1).padStart(2, '0') + '-' +
        String(now.getDate()).padStart(2, '0');
      eq(todayString(), expected);
    });

    test('dates.js', 'Given "2026-02-23" ‚Üí When getDayOfWeek ‚Üí expect 1 (Monday, ISO)', () => {
      eq(getDayOfWeek('2026-02-23'), 1);
    });

    test('dates.js', 'Given "2026-02-22" ‚Üí When getDayOfWeek ‚Üí expect 7 (Sunday, ISO)', () => {
      eq(getDayOfWeek('2026-02-22'), 7);
    });

    test('dates.js', 'Given "2026-02-27" ‚Üí When getDayOfWeek ‚Üí expect 5 (Friday, ISO)', () => {
      eq(getDayOfWeek('2026-02-27'), 5);
    });

    test('dates.js', 'Given Wednesday "2026-02-25" ‚Üí When getWeekStart ‚Üí expect Monday "2026-02-23"', () => {
      eq(getWeekStart('2026-02-25'), '2026-02-23');
    });

    test('dates.js', 'Given Monday "2026-02-23" ‚Üí When getWeekStart ‚Üí expect same Monday', () => {
      eq(getWeekStart('2026-02-23'), '2026-02-23');
    });

    test('dates.js', 'Given Sunday "2026-03-01" ‚Üí When getWeekStart ‚Üí expect previous Monday "2026-02-23"', () => {
      eq(getWeekStart('2026-03-01'), '2026-02-23');
    });

    test('dates.js', 'Given frequency="daily" ‚Üí When isWeeklyHabit ‚Üí expect false', () => {
      eq(isWeeklyHabit({ frequency: 'daily' }), false);
    });

    test('dates.js', 'Given frequency={type:"weekly", timesPerWeek:3} ‚Üí When isWeeklyHabit ‚Üí expect true', () => {
      eq(isWeeklyHabit({ frequency: { type: 'weekly', timesPerWeek: 3 } }), true);
    });

    test('dates.js', 'Given no frequency ‚Üí When isWeeklyHabit ‚Üí expect falsy', () => {
      ok(!isWeeklyHabit({}), 'Should be falsy');
    });

    test('dates.js', 'Given ["02-22","02-22","02-21"] ‚Üí When countByDate ‚Üí expect {02-22: 2, 02-21: 1}', () => {
      const dates = ['2026-02-22', '2026-02-22', '2026-02-21'];
      const result = countByDate(dates);
      eq(result['2026-02-22'], 2);
      eq(result['2026-02-21'], 1);
    });

    test('dates.js', 'Given "2026-02-23" ‚Üí When getISOWeekKey ‚Üí expect "2026-W09"', () => {
      eq(getISOWeekKey('2026-02-23'), '2026-W09');
    });

    test('dates.js', 'Given "2025-12-29" (year boundary) ‚Üí When getISOWeekKey ‚Üí expect "2026-W01"', () => {
      eq(getISOWeekKey('2025-12-29'), '2026-W01');
    });

    test('dates.js', 'When WEEKDAYS_MONDAY ‚Üí expect 7 entries from "Mo" to "So"', () => {
      eq(WEEKDAYS_MONDAY.length, 7);
      eq(WEEKDAYS_MONDAY[0], 'Mo');
      eq(WEEKDAYS_MONDAY[6], 'So');
    });

    // ========== dates.js - isHabitDueToday ==========
    // Note: isHabitDueToday only checks IF the habit is scheduled for today,
    // NOT whether the target has been met. Daily habits always return true.

    test('dates.js ‚Äì Due', 'Given daily habit ‚Üí When isHabitDueToday ‚Üí expect true (always due)', () => {
      ok(isHabitDueToday({ frequency: 'daily' }), 'Daily should always be due');
    });

    test('dates.js ‚Äì Due', 'Given weekly habit (3√ó/Woche) ‚Üí When isHabitDueToday ‚Üí expect true (flexible)', () => {
      ok(isHabitDueToday({ frequency: { type: 'weekly', timesPerWeek: 3 } }), 'Weekly should be due');
    });

    // ========== dates.js - Streaks ==========
    // calculateStreak(completionDates, habit) - dates are strings, not objects

    test('dates.js ‚Äì Streaks', 'Given 5 consecutive days ‚Üí When calculateStreak ‚Üí expect 5', () => {
      const habit = { frequency: 'daily', targetPerDay: 1 };
      const dates = [];
      for (let i = 0; i < 5; i++) dates.push(daysAgoStr(i));
      eq(calculateStreak(dates, habit), 5);
    });

    test('dates.js ‚Äì Streaks', 'Given no completions ‚Üí When calculateStreak ‚Üí expect 0', () => {
      eq(calculateStreak([], { frequency: 'daily', targetPerDay: 1 }), 0);
    });

    test('dates.js ‚Äì Streaks', 'Given today + 3 days ago (gap) ‚Üí When calculateStreak ‚Üí expect 1', () => {
      const habit = { frequency: 'daily', targetPerDay: 1 };
      const dates = [daysAgoStr(0), daysAgoStr(3)];
      eq(calculateStreak(dates, habit), 1);
    });

    test('dates.js ‚Äì Streaks', 'Given targetPerDay=2, today 2√ó, yesterday 2√ó ‚Üí When calculateStreak ‚Üí expect 2', () => {
      const habit = { frequency: 'daily', targetPerDay: 2 };
      const today = daysAgoStr(0);
      const yesterday = daysAgoStr(1);
      const dates = [today, today, yesterday, yesterday];
      eq(calculateStreak(dates, habit), 2);
    });

    test('dates.js ‚Äì Streaks', 'Given targetPerDay=2, yesterday only 1√ó ‚Üí When calculateStreak ‚Üí expect 1 (streak breaks)', () => {
      const habit = { frequency: 'daily', targetPerDay: 2 };
      const today = daysAgoStr(0);
      const yesterday = daysAgoStr(1);
      const dates = [today, today, yesterday];
      eq(calculateStreak(dates, habit), 1);
    });

    test('dates.js ‚Äì Streaks', 'Given old 10-day streak + current 2-day ‚Üí When calculateBestStreak ‚Üí expect ‚â•10', () => {
      const habit = { frequency: 'daily', targetPerDay: 1 };
      const dates = [];
      for (let i = 11; i <= 20; i++) dates.push(daysAgoStr(i));
      dates.push(daysAgoStr(0), daysAgoStr(1));
      const best = calculateBestStreak(dates, habit);
      const current = calculateStreak(dates, habit);
      ok(best >= 10, `Best should be ‚â•10, got ${best}`);
      ok(best > current, `Best (${best}) should be > current (${current})`);
    });

    // ========== sanitize.js ==========

    test('sanitize.js', 'Given HTML with script tags ‚Üí When escapeHtml ‚Üí expect &lt; entities', () => {
      const result = escapeHtml('<scr' + 'ipt>alert("xss")<\/scr' + 'ipt>');
      ok(!result.includes('<scr' + 'ipt>'), 'Should not contain raw script tag');
      ok(result.includes('&lt;'), 'Should contain &lt;');
    });

    test('sanitize.js', 'Given quotes & ampersands ‚Üí When escapeHtml ‚Üí expect escaped entities', () => {
      const result = escapeHtml('"quotes\' & ampersands"');
      ok(result.includes('&amp;'), 'Should escape &');
    });

    test('sanitize.js', 'Given plain text ‚Üí When escapeHtml ‚Üí expect unchanged output', () => {
      eq(escapeHtml('Hello World 123'), 'Hello World 123');
    });

    // ========== rewards.js ==========

    test('rewards.js', 'Given all rarities ‚Üí When RARITY_TO_STAGE ‚Üí expect 1,2,3,4,5', () => {
      eq(RARITY_TO_STAGE.common, 1);
      eq(RARITY_TO_STAGE.uncommon, 2);
      eq(RARITY_TO_STAGE.rare, 3);
      eq(RARITY_TO_STAGE.epic, 4);
      eq(RARITY_TO_STAGE.legendary, 5);
    });

    test('rewards.js', 'Given epic vs legendary ‚Üí When comparing stages ‚Üí expect different values', () => {
      ok(RARITY_TO_STAGE.legendary !== RARITY_TO_STAGE.epic, 'Legendary should differ from epic');
    });

    test('rewards.js', 'Given RARITY_LABELS ‚Üí When checking ‚Üí expect 5 German labels', () => {
      eq(Object.keys(RARITY_LABELS).length, 5);
      eq(RARITY_LABELS.common, 'Gew√∂hnlich');
      eq(RARITY_LABELS.legendary, 'Legend√§r');
    });

    test('rewards.js', 'Given RARITY_COLORS ‚Üí When checking ‚Üí expect 5 hex colors', () => {
      eq(Object.keys(RARITY_COLORS).length, 5);
      ok(RARITY_COLORS.legendary.startsWith('#'), 'Should be hex color');
    });

    // ========== Summary ==========
    const summary = document.getElementById('summary');
    const total = passed + failed;
    summary.className = `summary ${failed === 0 ? 'pass' : 'fail'}`;
    summary.textContent = failed === 0
      ? `‚úÖ Alle ${total} Tests bestanden!`
      : `‚ùå ${failed} von ${total} Tests fehlgeschlagen`;

  </script>
</body>
</html>
